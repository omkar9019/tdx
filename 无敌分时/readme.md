这是一个通达信分时图主图指标公式，它集成了趋势、支撑阻力、资金流向、成交量分析和买卖信号于一体。下面我将分模块详细解释其功能和作用。

公式整体概述

在分时图（每分钟行情）上为交易者提供一个全面的分析视角。它不仅显示价格，还通过大量计算来揭示背后的市场力量（如主力资金动向）、关键价位以及潜在的买卖点。

---

模块一：趋势与强弱判断 (均线系统)

```通达信
MA30:=EMA(CLOSE,30); //计算30周期的指数移动平均线，代表短期趋势。
强弱:EMA(CLOSE,900); //计算900周期的指数移动平均线，代表长期趋势或“强弱分界线”。
STICKLINE((MA30>强弱),MA30,强弱,1,0),COLOR0000FF; //当短期趋势线在长期线上方时，在两者之间画红色柱状线，表示强势。
STICKLINE((MA30<强弱),MA30,强弱,1,0),COLOR00FF00; //当短期趋势线在长期线下方时，在两者之间画绿色柱状线，表示弱势。
```

· 功能：直观地判断当前价格处于强势还是弱势区域。红色区域代表多头占优，绿色区域代表空头占优。

---

模块二：静态支撑与阻力

```通达信
H1:=MAX(DYNAINFO(3),DYNAINFO(5)); //取当日开盘价和最高价中的最大值。
L1:=MIN(DYNAINFO(3),DYNAINFO(6)); //取当日开盘价和最低价中的最小值。
P1:=H1-L1; //计算当日价格波动范围。
阻力:L1+P1*7/8,COLORYELLOW; //计算出理论阻力位（区间7/8处），画黄色线。
支撑:L1+P1*0.5/8,COLORYELLOW; //计算出理论支撑位（区间1/16处），画黄色线。
```

· 功能：基于当日价格范围，使用“江恩箱”或“菲波纳奇”等理论中的比例，预先画出可能遇到压力的阻力位和提供支撑的支撑位。这些是静态的，一天内不变。

---

模块三：主力资金监控 (核心模块)

这部分通过分析大成交量（V>4000，手）下的价格行为来推测主力和散户的买卖行为。

1. 定义资金流量：
   ```通达信
   主买量:=SUM(IF(C>REF(C,1) AND V>4000,V/1000,0),0),NODRAW; //大涨且量大，算作主力买入（单位：千手）
   主卖量:=SUM(IF(C<REF(C,1) AND V>4000,V/1000,0),0),NODRAW; //大跌且量大，算作主力卖出
   ... //类似地计算出总买量、总卖量，并由此推导出散户买卖量和各种净流入数据。
   ```
2. 绘制资金柱状图：
   ```通达信
   DRAWRECTREL(0,CONST(930-(ABS(主买量)*250/最大值)),35,950,...); //在图形固定位置绘制矩形
   ```
   · 功能：在指标窗口的左侧绘制红绿柱子，分别直观展示：
   · 主力买入和主力卖出量（前两个柱子）
   · 散户买入和散户卖出量（中间两个柱子）
   · 总体净流入（最后一个柱子，黄色/蓝色）
   · 解读：红色柱子代表“买入”力量强，绿色柱子代表“卖出”力量强。通过对比主力和散户的柱子，可以判断是主力在拉高出货还是吸筹。

---

模块四：动态均价与支撑系统

```通达信
均价线:SUM(V*C,0)/SUM(V,0),COLORYELLOW; //计算当日动态均价（VWAP），是分时图的核心线。
支撑位:EMA(均价线,50)/0.97,LINETHICK2,COLORGREEN; //对均价线进行平滑后下移3%，形成一条动态支撑线。
IF(支撑位>REF(支撑位,1),支撑位,DRAWNULL),COLORRED,LINETHICK2; //如果支撑位上移，用红色标记，表示趋势增强。
中位线:(均价线+支撑位)/2,DOTLINE,COLORGRAY; //计算均价和支撑位的中间线。
```

· 功能：
· 均价线：代表当日所有交易者的平均成本，股价在其上为强，其下为弱。
· 支撑位：提供一个动态的、基于成本的支撑参考，跌破此线可能意味着走弱。
· 支撑位变红是一个积极的信号。

---

模块五：成交量频率分析与机构买卖盘

1. 买频监控：
   ```通达信
   买频:COUNT(V>4000 AND C>REF(C,1),0); //统计历史上大成交量上涨的次数。
   黄频:COUNT(V>DYNAINFO(16)*10 AND C>REF(C,1),0),COLORYELLOW,NODRAW; //统计成交量超过10日均量10倍且上涨的次数。
   ```
   · 当“买频”和“黄频”增加且股价上穿支撑位时，标记“主力控盘”信号。
2. 机构买卖占比：
   ```通达信
   A1:=(DVOL/C)/2,NODRAW; //估算单笔成交金额（万元）
   A2:=SUM(IF(A1>100 AND CLOSE>REF(CLOSE,1),A1,0),0); //大单（>100万）买入总额
   A3:=SUM(IF(A1>100 AND CLOSE<REF(CLOSE,1),A1,0),0); //大单卖出总额
   ...
   DRAWTEXT_FIX(DD1=1,0.15,0.04,0,AAA1),COLORRED; //在图形左上角固定位置显示机构买入占比%
   DRAWTEXT_FIX(DD1=1,0.15,0.12,0,AAA2),COLORGREEN; //显示机构卖出占比%
   DRAWTEXT_FIX(DD1=1,0.15,0.20,0,AAA3),COLOR00FFFF; //显示机构净买入占比%
   ```

· 功能：直接量化并显示大资金（机构） 在当日交易中的参与程度和方向，是判断行情质量的重要依据。

---

模块六：买卖信号

```通达信
DRAWTEXT(LONGCROSS(支撑,现价,2),支撑*1.001,'B'),COLORRED; //股价上穿静态支撑线，发出‘B’买入信号。
DRAWTEXT(LONGCROSS(现价,阻力,2),现价,'S'),COLORGREEN; //股价上穿静态阻力线，发出‘S’卖出信号。
```

· 功能：提供基于静态支撑阻力位的简单交易信号。

---

模块七：MACD分时与趋势

```通达信
差离线:=EMA(CLOSE,12)-EMA(CLOSE,26);
平滑线:=EMA(差离线,9);
柱状值:=(差离线-平滑线)*2;
多头条件:=柱状值>0 AND 差离线>0 AND 平滑线>0; //定义MACD多头条件
趋势线:=MA(((SLOPE(C,20)*5)+C),10); //计算一个基于20周期斜率加权的趋势线
```

· 功能：在分时级别进行MACD分析，多头条件用于后续的“抓涨停”信号判断。趋势线用于判断短期趋势方向。

---

模块八：换手率显示

```通达信
真换手:=V*100*100/FINANCE(46)*2,NODRAW; //计算动态换手率（估计值）
换手:=真换手-30;
STICKLINE(C>=O,换手,-30,1.5,0),COLOR000044; //上涨时，换手率柱子为深蓝色
STICKLINE(C<O,换手,-30,1,0),COLOR004400; //下跌时，换手率柱子为深绿色
```

· 功能：将换手率情况以柱状图形式显示在底部，高度代表换手活跃程度。高换手率通常意味着关注度高，交易活跃。

---

模块九：突破抓涨停信号

这是公式中最复杂的策略信号，旨在捕捉早盘强势突破、有可能涨停的股票。

```通达信
早盘时段:=HOUR=10 AND MINUTE=0; //定义早盘10:00这个时间点
高点30:=HHV(H,30); //取前30分钟的最高点
间隔周期:=BARSLAST(早盘时段); //计算距离10:00已经过去了多少分钟
前高点:=REF(高点30,间隔周期); //取10:00时记录的前30分钟高点
前高常数:=CONST(前高点); //将该高点转化为固定常数，画一条水平线

触发条件:=CLOSE>前高常数 AND REF(C<=前高常数,1) AND CLOSE>趋势线; //当前价突破前高且站在趋势线上
过滤条件:=FILTER(触发条件,100); //过滤频繁信号
...
抓牛信号:=多头条件 AND 过滤条件 AND 价格限制 AND 前高点>最新价 AND 量比指标>=1;
DRAWICON(抓牛信号,前高常数,38); //画图标
DRAWTEXT(抓牛信号,C*0.998,'←抓涨停'),COLORYELLOW; //显示“抓涨停”文字
```

· 功能：这是一个盘中预警功能。如果股价在10:00之后放量突破了早盘前半小時（9:30-10:00）的高点，并且满足MACD多头、量比大于1等条件，就会在突破的点位标记一个“抓涨停”的信号，提示投资者关注该股后续封板的可能性。


使用注意事项：

1. 信号并非100%准确：任何指标都是基于历史数据的概率计算，不能保证绝对正确，尤其是“抓涨停”这类高风险策略。
2. 综合判断：不要依赖任何一个孤立的信号。应该将资金流向、机构占比、价格与均价线的关系、以及突破信号结合起来看，形成合力后再做决策。
3. 结合大盘环境：在大盘下跌趋势中，任何个股的买入信号成功率都会降低。
